---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import Pagination from '../../components/Pagination.astro';
import type { CollectionEntry } from 'astro:content';
import type { Page } from '../../types/dataTypes';
import { SITE, ISPARTOF } from '../../data/constant';
import turncateString from '../../utils/turncateString';
import Newsletter from '../../components/sections/Newsletter.astro';

const canonical = Astro.url.href;
interface Props {
  page: Page;
}

export async function getStaticPaths({ paginate }: any) {
  const PROJECT_PER_PAGE: number = 6;
  const allProjects: CollectionEntry<'projects'>[] = (
    await getCollection('projects')
  ).sort(
    (a: CollectionEntry<'projects'>, b: CollectionEntry<'projects'>) =>
      b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
  );

  return paginate(allProjects || [], {
    pageSize: PROJECT_PER_PAGE,
  });
}

const { page } = Astro.props;
const title: string = `Projects | ${SITE.title}`;
const description: string = 'Explore my portfolio of web development projects.';

const projectList = page.data;
const totalPages = Math.ceil(page.total / 6);
---

<MainLayout
  title={title}
  structuredData={{
    '@context': 'https://schema.org',
    '@type': 'WebPage',
    '@id': canonical,
    url: canonical,
    name: 'Projects | Melnerdz',
    description: description,
    isPartOf: ISPARTOF,
    inLanguage: 'en-US',
  }}
  meta={description}
>
  <section class="py-10 md:py-16">
    <!-- Header -->
    <div class="mb-12 text-center">
      <span class="mb-4 inline-block text-sm font-medium uppercase tracking-widest text-accent">
        Portfolio
      </span>
      <h1 class="mb-4 font-headfont text-3xl font-bold md:text-5xl">
        My <span class="gradient-text">Projects</span>
      </h1>
      <p class="mx-auto max-w-2xl text-lg text-text-muted">
        Discover my unique projects, including personal apps and client solutions, 
        all tailored to meet specific needs with innovation and quality.
      </p>
    </div>

    <!-- Projects grid -->
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {
        projectList.map((project, index) => (
          <article 
            class="group glass-card overflow-hidden rounded-2xl transition-all duration-300 hover-lift hover:border-accent/30"
            style={`animation-delay: ${index * 50}ms`}
          >
            <a href={`/projects/${project.id}`} class="block">
              <!-- Image -->
              <div class="relative aspect-[4/3] overflow-hidden">
                <Image
                  class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                  width={400}
                  height={300}
                  src={project.data.images[0].src}
                  alt={project.data.images[0].alt}
                />
                <div class="absolute inset-0 bg-gradient-to-t from-bg-primary via-bg-primary/20 to-transparent"></div>
                
                <!-- View overlay -->
                <div class="absolute inset-0 flex items-center justify-center bg-bg-primary/60 opacity-0 transition-opacity duration-300 group-hover:opacity-100">
                  <span class="flex items-center gap-2 rounded-full bg-accent px-4 py-2 text-sm font-medium text-bg-primary">
                    View Project
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                    </svg>
                  </span>
                </div>
              </div>

              <!-- Content -->
              <div class="p-5">
                <h2 class="mb-2 text-center font-headfont text-lg font-bold text-white transition-colors group-hover:text-accent">
                  {project.data.title}
                </h2>
                <p class="mb-4 text-center text-sm text-text-muted line-clamp-2">
                  {turncateString(project.data.shortDesc, 100)}
                </p>

                {/* Tech stack */}
                {project.data.technology && project.data.technology.length > 0 && (
                  <div class="flex flex-wrap justify-center gap-1.5">
                    {project.data.technology.slice(0, 3).map((tech: string) => (
                      <span class="rounded-full border border-accent/20 bg-accent-muted px-2 py-0.5 text-xs font-medium text-accent">
                        {tech}
                      </span>
                    ))}
                    {project.data.technology.length > 3 && (
                      <span class="rounded-full border border-border px-2 py-0.5 text-xs font-medium text-text-muted">
                        +{project.data.technology.length - 3}
                      </span>
                    )}
                  </div>
                )}
              </div>
            </a>
          </article>
        ))
      }
    </div>

    {totalPages > 1 && (
      <Pagination
        currentPage={page.currentPage}
        totalPages={totalPages}
        disablePrevious={page.url.prev === undefined}
        disableNext={page.url.next === undefined}
        next={page.url.next}
        prev={page.url.prev}
      />
    )}

    <Newsletter />
  </section>
</MainLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
