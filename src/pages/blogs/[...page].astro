---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import MainLayout from '../../layouts/MainLayout.astro';
import Pagination from '../../components/Pagination.astro';
import type { CollectionEntry } from 'astro:content';
import type { Page } from '../../types/dataTypes';
import { SITE, ISPARTOF } from '../../data/constant';
import Newsletter from '../../components/sections/Newsletter.astro';
import turncateString from '../../utils/turncateString';

const canonical = Astro.url.href;

interface Props {
  page: Page;
}

export async function getStaticPaths({ paginate }: any) {
  const POSTS_PER_PAGE: number = 6;
  const posts: CollectionEntry<'blogs'>[] = (await getCollection('blogs')).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
  );
  return paginate(posts || [], {
    pageSize: POSTS_PER_PAGE,
  });
}

const { page } = Astro.props;
const title: string = `Blog | ${SITE.title}`;
const description: string = 'Explore my latest articles and insights on web development.';

const articles = page.data;
const totalPages = Math.ceil(page.total / 6);

// Format date helper
const formatDate = (date: Date) => {
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  });
};
---

<MainLayout
  title={title}
  structuredData={{
    '@context': 'https://schema.org',
    '@type': 'WebPage',
    '@id': canonical,
    url: canonical,
    name: 'Blog | Melnerdz',
    isPartOf: ISPARTOF,
    inLanguage: 'en-US',
  }}
  meta={description}
>
  <section class="py-10 md:py-16">
    <!-- Header -->
    <div class="mb-12 text-center">
      <span class="mb-4 inline-block text-sm font-medium uppercase tracking-widest text-accent">
        Blog
      </span>
      <h1 class="mb-4 font-headfont text-3xl font-bold md:text-5xl">
        Latest <span class="gradient-text">Articles</span>
      </h1>
      <p class="mx-auto max-w-2xl text-lg text-text-muted">
        Read my latest insights, tutorials, and thoughts on web development, 
        technology, and more.
      </p>
    </div>

    <!-- Articles grid -->
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {
        articles.map((article, index) => (
          <article 
            class="group glass-card overflow-hidden rounded-2xl transition-all duration-300 hover-lift hover:border-accent/30"
            style={`animation-delay: ${index * 50}ms`}
          >
            <a href={`/blogs/${article.id}`} class="block">
              <!-- Image -->
              <div class="relative aspect-[16/10] overflow-hidden">
                <Image
                  class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                  width={400}
                  height={250}
                  src={article.data.image.src}
                  alt={article.data.image.alt}
                />
                <div class="absolute inset-0 bg-gradient-to-t from-bg-primary via-bg-primary/20 to-transparent"></div>
                
                <!-- Date badge -->
                <div class="absolute bottom-3 left-3 rounded-full border border-border bg-bg-secondary/80 px-3 py-1 text-xs font-medium text-text-muted backdrop-blur-sm">
                  {formatDate(article.data.pubDate)}
                </div>
              </div>

              <!-- Content -->
              <div class="p-5">
                <div class="flex items-start justify-between gap-2">
                  <h2 class="mb-2 font-headfont text-lg font-bold text-white transition-colors group-hover:text-accent line-clamp-2">
                    {article.data.title}
                  </h2>
                  <button
                    class="bookmark-btn flex-shrink-0 p-1 text-text-muted transition-colors hover:text-accent"
                    data-article-id={article.id}
                    data-article-title={article.data.title}
                    aria-label="Bookmark article"
                  >
                    <svg class="bookmark-icon h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                    </svg>
                    <svg class="bookmark-icon-filled hidden h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                    </svg>
                  </button>
                </div>
                <p class="text-sm text-text-muted leading-relaxed line-clamp-2">
                  {turncateString(article.data.description, 120)}
                </p>
                
                <!-- Read more indicator -->
                <div class="mt-4 inline-flex items-center gap-1 text-sm font-medium text-accent opacity-0 transition-opacity group-hover:opacity-100">
                  Read article
                  <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                  </svg>
                </div>
              </div>
            </a>
          </article>
        ))
      }
    </div>

    {totalPages > 1 && (
      <Pagination
        currentPage={page.currentPage}
        totalPages={totalPages}
        disablePrevious={!page.url.prev}
        disableNext={!page.url.next}
        next={page.url.next}
        prev={page.url.prev}
      />
    )}

    <Newsletter />
  </section>
</MainLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .bookmark-btn.bookmarked {
    color: var(--color-accent);
  }

  .bookmark-btn.bookmarked .bookmark-icon {
    display: none;
  }

  .bookmark-btn.bookmarked .bookmark-icon-filled {
    display: block;
  }
</style>

<script>
  interface BookmarkItem {
    id: string;
    title: string;
  }

  function initBookmarks() {
    const STORAGE_KEY = 'melnerdz-bookmarked-articles';

    function getBookmarks(): BookmarkItem[] {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return [];
        const parsed = JSON.parse(stored);
        // Handle legacy format (array of strings)
        if (Array.isArray(parsed) && parsed.length > 0 && typeof parsed[0] === 'string') {
          return parsed.map((id: string) => ({ id, title: id }));
        }
        return parsed;
      } catch {
        return [];
      }
    }

    function saveBookmarks(bookmarks: BookmarkItem[]) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(bookmarks));
      // Dispatch event for other components (like header panel)
      window.dispatchEvent(new CustomEvent('bookmarks-updated', { detail: bookmarks }));
    }

    function toggleBookmark(articleId: string, articleTitle: string): boolean {
      const bookmarks = getBookmarks();
      const index = bookmarks.findIndex(b => b.id === articleId);

      if (index > -1) {
        bookmarks.splice(index, 1);
        saveBookmarks(bookmarks);
        return false;
      } else {
        bookmarks.push({ id: articleId, title: articleTitle });
        saveBookmarks(bookmarks);
        return true;
      }
    }

    function isBookmarked(articleId: string): boolean {
      return getBookmarks().some(b => b.id === articleId);
    }

    function updateButtonState(button: HTMLButtonElement, bookmarked: boolean) {
      button.classList.toggle('bookmarked', bookmarked);
      button.setAttribute('aria-label', bookmarked ? 'Remove bookmark' : 'Bookmark article');
    }

    // Initialize bookmark buttons
    const bookmarkButtons = document.querySelectorAll<HTMLButtonElement>('.bookmark-btn');

    bookmarkButtons.forEach((button) => {
      const articleId = button.dataset.articleId;
      const articleTitle = button.dataset.articleTitle || articleId;
      if (!articleId) return;

      // Set initial state
      updateButtonState(button, isBookmarked(articleId));

      // Handle click
      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isNowBookmarked = toggleBookmark(articleId, articleTitle!);
        updateButtonState(button, isNowBookmarked);
      });
    });
  }

  // Run on initial load and after view transitions
  initBookmarks();
  document.addEventListener('astro:after-swap', initBookmarks);
</script>
