---
import { Image } from 'astro:assets';
import type { ProjectImage } from '../types/dataTypes';

interface Props {
  images: ProjectImage[];
}

const { images } = Astro.props;
const isSingleImage = images.length === 1;
---

<div class="image-carousel relative w-full" data-carousel>
  <div class="overflow-hidden rounded-md">
    <div
      class="carousel-track flex transition-transform duration-300 ease-in-out"
      data-carousel-track
    >
      {
        images.map((image, index) => (
          <div class="carousel-slide w-full flex-shrink-0" data-index={index}>
            <Image
              width={700}
              height={600}
              src={image.src}
              alt={image.alt}
              sizes="(max-width: 1024px) 100vw, 700px"
              class="h-auto w-full"
            />
          </div>
        ))
      }
    </div>
  </div>

  {
    !isSingleImage && (
      <>
        <button
          type="button"
          class="carousel-btn carousel-prev absolute left-2 top-1/2 -translate-y-1/2 rounded-full bg-black/50 p-2 text-white transition-colors hover:bg-black/70 focus:outline-none focus:ring-2 focus:ring-white/50"
          data-carousel-prev
          aria-label="Previous image"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15 19l-7-7 7-7"
            />
          </svg>
        </button>

        <button
          type="button"
          class="carousel-btn carousel-next absolute right-2 top-1/2 -translate-y-1/2 rounded-full bg-black/50 p-2 text-white transition-colors hover:bg-black/70 focus:outline-none focus:ring-2 focus:ring-white/50"
          data-carousel-next
          aria-label="Next image"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9 5l7 7-7 7"
            />
          </svg>
        </button>

        <div
          class="carousel-dots absolute bottom-4 left-1/2 flex -translate-x-1/2 gap-2"
          data-carousel-dots
        >
          {images.map((_, index) => (
            <button
              type="button"
              class:list={[
                'h-2 w-2 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-white/50',
                index === 0 ? 'bg-white' : 'bg-white/50',
              ]}
              data-carousel-dot={index}
              aria-label={`Go to image ${index + 1}`}
            />
          ))}
        </div>
      </>
    )
  }
</div>

<script>
  function initCarousels() {
    document.querySelectorAll('[data-carousel]').forEach((carousel) => {
      const track = carousel.querySelector(
        '[data-carousel-track]',
      ) as HTMLElement;
      const slides = carousel.querySelectorAll('.carousel-slide');
      const prevBtn = carousel.querySelector('[data-carousel-prev]');
      const nextBtn = carousel.querySelector('[data-carousel-next]');
      const dots = carousel.querySelectorAll('[data-carousel-dot]');

      if (!track || slides.length <= 1) return;

      let currentIndex = 0;
      const totalSlides = slides.length;

      function updateCarousel() {
        track.style.transform = `translateX(-${currentIndex * 100}%)`;

        dots.forEach((dot, index) => {
          if (index === currentIndex) {
            dot.classList.remove('bg-white/50');
            dot.classList.add('bg-white');
          } else {
            dot.classList.remove('bg-white');
            dot.classList.add('bg-white/50');
          }
        });
      }

      function goToSlide(index: number) {
        currentIndex = (index + totalSlides) % totalSlides;
        updateCarousel();
      }

      prevBtn?.addEventListener('click', () => goToSlide(currentIndex - 1));
      nextBtn?.addEventListener('click', () => goToSlide(currentIndex + 1));

      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => goToSlide(index));
      });

      // Keyboard navigation
      carousel.addEventListener('keydown', (e) => {
        const event = e as KeyboardEvent;
        if (event.key === 'ArrowLeft') goToSlide(currentIndex - 1);
        if (event.key === 'ArrowRight') goToSlide(currentIndex + 1);
      });

      // Touch/swipe support
      let touchStartX = 0;
      let touchEndX = 0;

      track.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      });

      track.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            goToSlide(currentIndex + 1);
          } else {
            goToSlide(currentIndex - 1);
          }
        }
      });
    });
  }

  // Initialize on page load
  initCarousels();

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initCarousels);
</script>
