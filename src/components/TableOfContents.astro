---
interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
}

const { headings } = Astro.props;

// Filter to only include h2 and h3 headings
const filteredHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

{
  filteredHeadings.length > 0 && (
    <nav class="toc" aria-label="Table of contents">
      <h2 class="mb-4 text-sm font-semibold uppercase tracking-wider text-text-muted">
        On this page
      </h2>
      <ul class="space-y-2 text-sm">
        {filteredHeadings.map((heading) => (
          <li class={heading.depth === 3 ? 'ml-4' : ''}>
            <a
              href={`#${heading.slug}`}
              class="toc-link block py-1 text-text-muted transition-colors duration-200 hover:text-accent"
              data-heading={heading.slug}
            >
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  )
}

<script>
  function initTOC() {
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = document.querySelectorAll('h2[id], h3[id]');

    if (tocLinks.length === 0 || headings.length === 0) return;

    const observerOptions = {
      root: null,
      rootMargin: '-80px 0px -70% 0px',
      threshold: 0,
    };

    let activeId: string | null = null;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          activeId = entry.target.id;
          updateActiveLink(activeId);
        }
      });
    }, observerOptions);

    headings.forEach((heading) => observer.observe(heading));

    function updateActiveLink(id: string | null) {
      tocLinks.forEach((link) => {
        const linkEl = link as HTMLAnchorElement;
        if (linkEl.dataset.heading === id) {
          linkEl.classList.remove('text-text-muted');
          linkEl.classList.add('text-accent', 'font-medium');
        } else {
          linkEl.classList.remove('text-accent', 'font-medium');
          linkEl.classList.add('text-text-muted');
        }
      });
    }

    // Smooth scroll behavior
    tocLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = (link as HTMLAnchorElement).dataset.heading;
        const targetEl = document.getElementById(targetId || '');
        if (targetEl) {
          targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
          history.pushState(null, '', `#${targetId}`);
        }
      });
    });
  }

  // Initialize on page load
  initTOC();

  // Re-initialize after Astro view transitions
  document.addEventListener('astro:after-swap', initTOC);
</script>
