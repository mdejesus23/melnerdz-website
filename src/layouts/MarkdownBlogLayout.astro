---
import { Image } from 'astro:assets';
import type { Project, Blog } from '../types/dataTypes';
import MainLayout from './MainLayout.astro';
import Prose from '../components/Prose.astro';
import { SITE, ISPARTOF } from '../data/constant';
import { countWords } from '@/utils/countWords';
import Newsletter from '@/components/sections/Newsletter.astro';
import TableOfContents from '@/components/TableOfContents.astro';
import Breadcrumbs from '@/components/ui/Breadcrumbs.astro';
import FaqAccordion from '@/components/FaqAccordion.astro';

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  data: Project | Blog;
  slug: string;
  collection: string;
  body?: string;
  headings?: Heading[];
}

const { data, slug, collection, body, headings = [] }: Props = Astro.props;

const canonical = Astro.url.href;
const title: string = `${data.title} | ${SITE.title}`;
const description: string = data.description;

const wordCount = countWords(body || '');
const readTime = Math.ceil(wordCount / 200); // Assuming 200 words per minute

// Generate dynamic OG image path
const ogImagePath = `/og/${collection}/${slug}.png`;

// Breadcrumbs data
const collectionLabel = collection === 'blogs' ? 'Blogs' : 'Projects';
const collectionHref = `/${collection}`;

const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: collectionLabel, href: collectionHref },
  { label: data.title },
];

// Determine if this is an article (blog) or a web page (project)
const isArticle = collection === 'blogs';
const pageType = isArticle ? 'Article' : 'WebPage';

// Get FAQs from blog data (if available)
const faqs = isArticle && 'faqs' in data ? (data as Blog).faqs : undefined;

// Build FAQ schema for SEO (if FAQs exist)
const faqSchema =
  faqs && faqs.length > 0
    ? {
        '@context': 'https://schema.org',
        '@type': 'FAQPage',
        mainEntity: faqs.map((faq) => ({
          '@type': 'Question',
          name: faq.question,
          acceptedAnswer: {
            '@type': 'Answer',
            text: faq.answer,
          },
        })),
      }
    : null;

// Build page schema based on type
const pageSchema = isArticle
  ? {
      '@context': 'https://schema.org',
      '@type': 'Article',
      '@id': canonical,
      url: canonical,
      headline: data.title,
      description: description,
      image: `${SITE.url}${ogImagePath}`,
      datePublished: data.pubDate
        ? new Date(data.pubDate).toISOString()
        : undefined,
      author: {
        '@type': 'Person',
        name: SITE.author,
        url: SITE.url,
      },
      publisher: {
        '@type': 'Person',
        name: SITE.author,
        url: SITE.url,
      },
      isPartOf: ISPARTOF,
      inLanguage: 'en-US',
    }
  : {
      '@context': 'https://schema.org',
      '@type': 'WebPage',
      '@id': canonical,
      url: canonical,
      name: `${data.title} | Melnerdz website`,
      description: description,
      isPartOf: ISPARTOF,
      inLanguage: 'en-US',
    };

// Breadcrumbs structured data (JSON-LD)
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: SITE.url,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: collectionLabel,
      item: `${SITE.url}${collectionHref}`,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: data.title,
      item: canonical,
    },
  ],
};
---

<MainLayout
  title={title}
  structuredData={[
    pageSchema,
    breadcrumbSchema,
    ...(faqSchema ? [faqSchema] : []),
  ]}
  meta={description}
  ogData={{
    title: `${data.title} | ${SITE.title}`,
    description: description,
    image: ogImagePath,
  }}
>
  <section class="mx-auto max-w-screen-xl py-6">
    <Breadcrumbs items={breadcrumbItems} />
    <h1 class="mb-4 text-center font-headfont text-3xl font-bold">
      {data.title}
    </h1>

    <p class="mb-10 text-center text-sm text-neutral-500 dark:text-neutral-400">
      {
        data.pubDate
          ? new Date(data.pubDate).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })
          : ''
      }
      &nbsp; â€¢ &nbsp;
      {readTime} min read
    </p>

    <button
      class="bookmark-btn tooltip flex-shrink-0 p-1 text-text-muted transition-colors hover:text-accent"
      data-article-id={slug}
      data-article-title={data.title}
      aria-label="Bookmark article"
    >
      <svg
        class="bookmark-icon h-5 w-5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
      </svg>
      <svg
        class="bookmark-icon-filled hidden h-5 w-5"
        fill="currentColor"
        viewBox="0 0 24 24"
      >
        <path d="M5 5a2 2 0 012-2h10a2 2v16l-7-3.5L5 21V5z"></path>
      </svg>
      <span class="tooltiptext">Bookmark article</span>
    </button>

    <div class="relative flex flex-col gap-10 lg:flex-row">
      <!-- Table of Contents - Left Sidebar -->
      {
        headings.length > 0 && (
          <aside class="hidden w-64 shrink-0 lg:block">
            <div class="sticky top-24">
              <TableOfContents headings={headings} />
            </div>
          </aside>
        )
      }

      <!-- Main Content -->
      <div class="mx-auto flex w-full max-w-prose flex-1 flex-col gap-5">
        <figure class="mx-auto w-full">
          <Image
            width={700}
            height={600}
            src={(data as Blog).image.src}
            alt={(data as Blog).image.alt}
            sizes="(max-width: 1024px) 100vw, 700px"
            class="h-auto w-full rounded-md"
          />
        </figure>
        <Prose>
          <slot />
        </Prose>
        {faqs && faqs.length > 0 && <FaqAccordion faqs={faqs} />}
      </div>
    </div>
  </section>
  <Newsletter />
</MainLayout>

<style>
  .bookmark-btn.bookmarked {
    color: var(--color-accent);
  }

  .bookmark-btn.bookmarked .bookmark-icon {
    display: none;
  }

  .bookmark-btn.bookmarked .bookmark-icon-filled {
    display: block;
  }

  /* Tooltip styles */
  .tooltip {
    position: relative;
    display: inline-block;
  }

  .tooltip .tooltiptext {
    visibility: hidden;
    width: 120px;
    background-color: var(--color-bg-secondary);
    color: var(--color-text-muted);
    text-align: center;
    border-radius: 4px;
    padding: 5px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -60px;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
  }
</style>

<script>
  interface BookmarkItem {
    id: string;
    title: string;
  }

  function initBookmarks() {
    const STORAGE_KEY = 'melnerdz-bookmarked-articles';

    function getBookmarks(): BookmarkItem[] {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return [];
        const parsed = JSON.parse(stored);
        // Handle legacy format (array of strings)
        if (Array.isArray(parsed) && parsed.length > 0 && typeof parsed[0] === 'string') {
          return parsed.map((id: string) => ({ id, title: id }));
        }
        return parsed;
      } catch {
        return [];
      }
    }

    function saveBookmarks(bookmarks: BookmarkItem[]) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(bookmarks));
      // Dispatch event for other components (like header panel)
      window.dispatchEvent(new CustomEvent('bookmarks-updated', { detail: bookmarks }));
    }

    function toggleBookmark(articleId: string, articleTitle: string): boolean {
      const bookmarks = getBookmarks();
      const index = bookmarks.findIndex(b => b.id === articleId);

      if (index > -1) {
        bookmarks.splice(index, 1);
        saveBookmarks(bookmarks);
        return false;
      } else {
        bookmarks.push({ id: articleId, title: articleTitle });
        saveBookmarks(bookmarks);
        return true;
      }
    }

    function isBookmarked(articleId: string): boolean {
      return getBookmarks().some(b => b.id === articleId);
    }

    function updateButtonState(button: HTMLButtonElement, bookmarked: boolean) {
      button.classList.toggle('bookmarked', bookmarked);
      button.setAttribute('aria-label', bookmarked ? 'Remove bookmark' : 'Bookmark article');

      const tooltip = button.querySelector('.tooltiptext');
      if (tooltip) {
        tooltip.textContent = bookmarked ? 'Remove bookmark' : 'Bookmark article';
      }
    }

    // Initialize bookmark buttons
    const bookmarkButtons = document.querySelectorAll<HTMLButtonElement>('.bookmark-btn');

    bookmarkButtons.forEach((button) => {
      const articleId = button.dataset.articleId;
      const articleTitle = button.dataset.articleTitle || articleId;
      if (!articleId) return;

      // Set initial state
      updateButtonState(button, isBookmarked(articleId));

      // Handle click
      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isNowBookmarked = toggleBookmark(articleId, articleTitle!);
        updateButtonState(button, isNowBookmarked);
      });
    });
  }

  // Run on initial load and after view transitions
  initBookmarks();
  document.addEventListener('astro:after-swap', initBookmarks);
</script>
